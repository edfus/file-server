<!DOCTYPE html>
<html>

<head>
  <title>File-Server.local</title>
  <link rel="modulepreload" href="/_lib_/www/request.js">
  <link rel="stylesheet" href="/_lib_/www/style/common.css">
  <link rel="stylesheet" href="/_lib_/www/style/dark.css" media="(prefers-color-scheme: dark)">
  <script src="/_lib_/www/custom-elements.js" type="module"></script>
</head>

<body>
  <main style="margin: 10% auto;">
    <section>
      <div>
        <label for="get-file-input">What do you want?</label>
        <input type="search" id="get-file-input" name="q" pattern="[^|>&*']*" list="get-file-input-datalist">
        <button id="download-button">download</button>
        <datalist id="get-file-input-datalist"></datalist>
        <div>
          <input type="checkbox" id="is-range-request" name="r">
          <label for="is-range-request">Use multithreaded download</label>

          <span id="threads-count-wrapper" style="visibility: visible;">
            <input type="range" id="threads-count" name="t" min="4" max="32" value="12" step="2"
              style="visibility: inherit;">
            <label for="threads-count" style="visibility: inherit;">12 threads</label>
            <small id="multithreads-attention" style="visibility: inherit;">
              Attention: multithreaded download will consume up to 384 MiB RAM
            </small>
          </span>
        </div>
      </div>
      <div>
        <div style="display: flex; justify-content: space-between;">
          <label for="log">Output log:</label>
          <input type="reset" id="clear-log" value="Clear" style="font-size: 0.6rem;">
        </div>
        <textarea id="log" name="log" rows="5" cols="33" placeholder="It was a dark and stormy night..."></textarea>
      </div>
    </section>
    <section style="margin-top: 7rem;">
      <div>
        <label for="file-uploader">...Or Upload file</label>
        <input id="file-uploader" type="file"/>
        <span>to</span>
        <input id="upload-target" type="text" placeholder="optional" minlength="1" maxlength="40" size="25" />
        <section style="margin-top: 1rem">
          <div>
            <label for="username" style="display: inline-block; width: 5rem;">Username:</label>
            <input type="text" id="username" name="username">
  
            <div>
              <label for="pass" style="display: inline-block; width: 5rem;">Password:</label>
              <input type="password" id="password" name="password" minlength="8" required>
            </div>
          </div>

          <button type="submit" id="upload-button">upload</button>
        </section>
      </div>
    </section>
  </main>
  <aside id="dark-mode-toggle-wrapper">
    <dark-mode-toggle id="dark-mode-toggle" permanent="true" legend="Dark Mode" light="off" dark="on" remember="" mode="light" appearance="toggle"></dark-mode-toggle>
  </aside>
</body>
<script type="module">
  /**
   * isRangeRequest style
   */
  const map = { "true": "visible", "false": "hidden" };
  const isRangeRequest = document.getElementById("is-range-request");
  const threadsCountWrapper = document.getElementById("threads-count-wrapper");

  isRangeRequest.onchange = () => {
    threadsCountWrapper.style.visibility = map[
      String(Boolean(isRangeRequest.checked))
    ];
    localStorage["isRangeRequest.checked"] = String(Boolean(isRangeRequest.checked));
  };

  isRangeRequest.checked = localStorage["isRangeRequest.checked"] !== "false";
  isRangeRequest.onchange();

  /**
   * threadsSelector style
   */
  const threadsSelector = document.getElementById("threads-count");
  const threadsSelectorLabel = threadsSelector.parentNode.querySelector('label[for="threads-count"]');
  const multithreadsAttention = threadsSelector.parentNode.querySelector('#multithreads-attention');
  threadsSelector.onchange = () => {
    const v = threadsSelector.value.length === 1 ? "&nbsp;&nbsp;".concat(threadsSelector.value) : threadsSelector.value;
    threadsSelectorLabel.innerHTML = `${v} threads`;
    multithreadsAttention.innerText =
      multithreadsAttention.innerText.replace(/\d+(?=\sMiB\sRAM$)/i, Number(threadsSelector.value) * 32)
      ;
    localStorage["threadsSelector.value"] = threadsSelector.value;
  }
  threadsSelector.value = Number(localStorage["threadsSelector.value"]);
  threadsSelector.onchange();

  /**
   * log style
   */
  const log = document.getElementById("log");

  log.value = "$: ";
  document.getElementById("clear-log").addEventListener("click", () => log.value = "$:", { passive: true });

  function logAppend(...argv) {
    log.value += argv.join(" ").concat("\n");
  }

  /**
   * upload style
   */
  const username = document.getElementById("username");
  const password = document.getElementById("password");


  username.addEventListener("keyup", event => {
    if(event.key === "ArrowDown" || event.key === "Enter") {
      password.focus();
    }
  });

  password.addEventListener("keyup", event => {
    if(event.key === "ArrowUp") {
      username.focus();
    }
    if(event.key === "Enter") {
      uploadButton.click();
    }
  });

  if(localStorage["username"])
    username.value = localStorage["username"];

  /**
   * networking
   */
  import {
    download,
    upload,
    setList,
    ProgressLog
  } from "/_lib_/www/request.js";

  const beforeUnloadHandler = event => {
    event.preventDefault();
    return event.returnValue = "Are you sure you want to exit?";
  };

  function couplingDownload () {
    if (!pathInput.value)
      return logAppend("input required.");

    const pathname = pathInput.value
      .replace("\\", "/")
      .replace(/\s/, "+")
      .replace(/^([^\/])/, "/$1")
    ;

    if (!ProgressLog.instance) new ProgressLog(log);

    window.addEventListener("beforeunload", beforeUnloadHandler);

    return (
      download(pathname)
        .catch(err => {
          console.error(err);
          setTimeout(() => logAppend(url.pathname, err.message), 20);
        })
        .finally(
          () => window.removeEventListener("beforeunload", beforeUnloadHandler)
        )
    );
  }

  /**
   * download
   */
  const pathInput = document.getElementById("get-file-input");
  const dataList = document.getElementById("get-file-input-datalist");
  const downloadButton = document.getElementById("download-button");

  setList(dataList);
  pathInput.addEventListener("focus", () => setList(dataList));
  downloadButton.addEventListener("click", couplingDownload, { passive: true });
  pathInput.addEventListener("keyup", e => e.key === "Enter" && couplingDownload());

  /**
   * upload
   */
  const fileSelect = document.getElementById("file-uploader");
  const uploadDestination = document.getElementById("upload-target");
  const uploadButton = document.getElementById("upload-button");

  uploadButton.addEventListener("click", () => {
    if(!fileSelect.files.length)
      return logAppend("input required");

    localStorage["username"] = username.value;

    const file = fileSelect.files[0];
    const destination = uploadDestination.value || file.name;
    
    return (
      upload(file, destination)
        .then(async res => logAppend(
          `Uploaded '${destination}' to ${decodeURIComponent(res.headers.get("Content-Location"))} - ${res.status} ${await res.text() || res.statusText}`
        ))
        .catch(err => logAppend(
          `Upload '${destination}' errored: ${err.message}`
        ))
        .then(() => setList(dataList))
    );
  });
</script>

</html>